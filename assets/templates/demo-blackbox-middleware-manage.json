{
  "id": "demo-blackbox-middleware-manage-v1",
  "name": "Demo Blackbox Middleware Manage v1",
  "mode": "manage",
  "vars": {
    "STACK_ID": {
      "type": "string",
      "group": "service",
      "required": true,
      "default": "blackbox-middleware",
      "example": "fcs-blackbox",
      "description": "stack identifier for state/evidence naming"
    },
    "SERVICE_NAME": {
      "type": "string",
      "group": "service",
      "required": true,
      "default": "blackbox-service",
      "example": "fcs-server",
      "description": "logical service name"
    },
    "SERVICE_UNIT": {
      "type": "string",
      "group": "runtime",
      "required": true,
      "default": "blackbox.service",
      "example": "fcs.service",
      "description": "systemd unit name"
    },
    "PROCESS_MATCH": {
      "type": "string",
      "group": "runtime",
      "required": true,
      "default": "blackbox-service",
      "example": "fcs",
      "description": "process match keyword for process args evidence"
    },
    "SERVICE_PORT": {
      "type": "int",
      "group": "service",
      "required": true,
      "default": "18080",
      "example": "18080",
      "description": "service listening port"
    },
    "HEALTH_HOST": {
      "type": "string",
      "group": "network",
      "required": true,
      "default": "localhost",
      "example": "localhost",
      "description": "host used in dns_resolve checks"
    },
    "APP_DIR": {
      "type": "string",
      "group": "paths",
      "required": true,
      "default": "/opt/blackbox",
      "example": "/opt/fcs",
      "description": "application installation path"
    },
    "DATA_DIR": {
      "type": "string",
      "group": "paths",
      "required": true,
      "default": "/data/blackbox",
      "example": "/data/fcs",
      "description": "data path"
    },
    "LOG_DIR": {
      "type": "string",
      "group": "paths",
      "required": true,
      "default": "/logs/blackbox",
      "example": "/logs/fcs",
      "description": "log path"
    },
    "INSTALL_ROOT": {
      "type": "string",
      "group": "paths",
      "required": true,
      "example": "/data/opskit-fcs",
      "description": "output root for state/reports"
    },
    "EVIDENCE_DIR": {
      "type": "string",
      "group": "paths",
      "required": true,
      "example": "/data/opskit-fcs/evidence",
      "description": "evidence output directory"
    },
    "MAX_RESTARTS": {
      "type": "int",
      "group": "runtime",
      "required": true,
      "default": "3",
      "example": "3",
      "description": "max allowed systemd restart count"
    },
    "ROOT_MOUNT": {
      "type": "string",
      "group": "runtime",
      "required": true,
      "default": "/",
      "example": "/",
      "description": "target mount used by disk/fs checks"
    },
    "RECOVER_TRIGGER": {
      "type": "string",
      "group": "runtime",
      "required": true,
      "default": "blackbox_monitor",
      "example": "fcs_blackbox_monitor",
      "description": "recover trigger source tag"
    }
  },
  "stages": {
    "A": {
      "checks": [
        {
          "id": "a.system_info",
          "kind": "system_info",
          "enabled": true
        },
        {
          "id": "a.time_sync_status",
          "kind": "time_sync_status",
          "params": {
            "severity": "warn"
          },
          "enabled": true
        },
        {
          "id": "a.default_route",
          "kind": "default_route",
          "params": {
            "severity": "warn"
          },
          "enabled": true
        },
        {
          "id": "a.dns_config",
          "kind": "dns_config",
          "params": {
            "severity": "warn"
          },
          "enabled": true
        },
        {
          "id": "a.systemd_available",
          "kind": "systemd_available",
          "params": {
            "severity": "warn"
          },
          "enabled": true
        },
        {
          "id": "a.mount_check",
          "kind": "mount_check",
          "params": {
            "required_mounts": [
              "${ROOT_MOUNT}"
            ]
          },
          "enabled": true
        },
        {
          "id": "a.port_conflict",
          "kind": "port_conflict",
          "params": {
            "reserved_ports": [
              "${SERVICE_PORT}"
            ]
          },
          "enabled": true
        },
        {
          "id": "a.systemd_unit_exists",
          "kind": "systemd_unit_exists",
          "params": {
            "unit": "${SERVICE_UNIT}",
            "severity": "warn"
          },
          "enabled": true
        }
      ]
    },
    "B": {
      "actions": [
        {
          "id": "b.ensure_paths",
          "kind": "ensure_paths",
          "params": {
            "paths": [
              "${INSTALL_ROOT}/runtime",
              "${INSTALL_ROOT}/state",
              "${INSTALL_ROOT}/reports",
              "${EVIDENCE_DIR}"
            ],
            "perm": "755"
          },
          "enabled": true
        },
        {
          "id": "b.baseline_snapshot",
          "kind": "baseline_snapshot",
          "params": {
            "paths": [
              "${APP_DIR}",
              "${DATA_DIR}",
              "${LOG_DIR}",
              "${CONF_DIR}",
              "${INSTALL_ROOT}/state"
            ],
            "output": "${BASELINE_SNAPSHOT}"
          },
          "enabled": true
        }
      ]
    },
    "C": {
      "actions": [
        {
          "id": "c.capture_inventory",
          "kind": "capture_inventory",
          "params": {
            "units": [
              "${SERVICE_UNIT}"
            ],
            "ports": [
              "${SERVICE_PORT}"
            ],
            "paths": [
              "${APP_DIR}",
              "${DATA_DIR}",
              "${LOG_DIR}",
              "${CONF_DIR}",
              "${INSTALL_ROOT}/state"
            ],
            "output": "${INVENTORY_FILE}"
          },
          "enabled": true
        },
        {
          "id": "c.declare_stack",
          "kind": "declare_stack",
          "params": {
            "output": "${STACK_DECLARATION}",
            "stack_id": "${STACK_ID}",
            "mode": "manage",
            "components": [
              "${SERVICE_NAME}"
            ]
          },
          "enabled": true
        }
      ]
    },
    "D": {
      "checks": [
        {
          "id": "d.systemd_unit_exists",
          "kind": "systemd_unit_exists",
          "params": {
            "unit": "${SERVICE_UNIT}",
            "severity": "fail"
          },
          "enabled": true
        },
        {
          "id": "d.systemd_unit_active",
          "kind": "systemd_unit_active",
          "params": {
            "unit": "${SERVICE_UNIT}",
            "severity": "fail"
          },
          "enabled": true
        },
        {
          "id": "d.port_listening",
          "kind": "port_listening",
          "params": {
            "port": "${SERVICE_PORT}",
            "severity": "fail"
          },
          "enabled": true
        },
        {
          "id": "d.systemd_restart_count",
          "kind": "systemd_restart_count",
          "params": {
            "unit": "${SERVICE_UNIT}",
            "max_restarts": "${MAX_RESTARTS}",
            "severity": "warn"
          },
          "enabled": true
        },
        {
          "id": "d.dns_resolve",
          "kind": "dns_resolve",
          "params": {
            "host": "${HEALTH_HOST}",
            "min_records": 1,
            "skip_network_query": true,
            "severity": "warn"
          },
          "enabled": true
        },
        {
          "id": "d.disk_usage_root",
          "kind": "disk_usage",
          "params": {
            "mount": "${ROOT_MOUNT}",
            "max_used_percent": 90,
            "severity": "warn"
          },
          "enabled": true
        },
        {
          "id": "d.memory_available",
          "kind": "memory_available",
          "params": {
            "min_available_mb": 512,
            "severity": "warn"
          },
          "enabled": true
        },
        {
          "id": "d.load_average",
          "kind": "load_average",
          "params": {
            "max_load1": 8,
            "severity": "warn"
          },
          "enabled": true
        },
        {
          "id": "d.fs_readonly",
          "kind": "fs_readonly",
          "params": {
            "mounts": [
              "${ROOT_MOUNT}"
            ],
            "severity": "fail"
          },
          "enabled": true
        }
      ]
    },
    "E": {
      "actions": [
        {
          "id": "e.recover_blackbox",
          "kind": "recover_sequence",
          "params": {
            "units": [
              "${SERVICE_UNIT}"
            ],
            "allow_empty_units": false,
            "max_attempts": 1,
            "cooldown_seconds": 600,
            "readiness_network": true,
            "readiness_mounts": [
              "${ROOT_MOUNT}"
            ],
            "trigger_source": "${RECOVER_TRIGGER}",
            "stage": "E",
            "circuit_file": "${RECOVER_CIRCUIT_FILE}",
            "collect_file": "${RECOVER_COLLECT_FILE}",
            "collect_bundle_dir": "${COLLECT_BUNDLE_DIR}",
            "collect_paths": [
              "${APP_DIR}",
              "${DATA_DIR}",
              "${LOG_DIR}",
              "${CONF_DIR}",
              "${INSTALL_ROOT}/state"
            ],
            "redact_keys": [
              "password",
              "token",
              "secret"
            ]
          },
          "enabled": false
        }
      ]
    },
    "F": {
      "evidence": [
        {
          "id": "f.state_dir_hash",
          "kind": "dir_hash",
          "params": {
            "dir": "${INSTALL_ROOT}/state",
            "output": "${EVIDENCE_DIR}/${STACK_ID}-state-dir-hash.json"
          },
          "enabled": true
        },
        {
          "id": "f.overall_json_hash",
          "kind": "file_hash",
          "params": {
            "file": "${INSTALL_ROOT}/state/overall.json",
            "output": "${EVIDENCE_DIR}/${STACK_ID}-overall-json-hash.json"
          },
          "enabled": true
        },
        {
          "id": "f.process_args",
          "kind": "process_args",
          "params": {
            "match": "${PROCESS_MATCH}",
            "output": "${EVIDENCE_DIR}/${STACK_ID}-process-args.json",
            "redact_keys": [
              "password",
              "token",
              "secret"
            ]
          },
          "enabled": true
        },
        {
          "id": "f.systemd_status",
          "kind": "command_output",
          "params": {
            "name": "systemctl",
            "args": [
              "status",
              "${SERVICE_UNIT}",
              "--no-pager"
            ],
            "output": "${EVIDENCE_DIR}/${STACK_ID}-systemd-status.json",
            "redact_keys": [
              "password",
              "token",
              "secret"
            ]
          },
          "enabled": true
        }
      ]
    }
  }
}
