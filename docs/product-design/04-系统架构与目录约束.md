# 04 系统架构与目录约束

## 4.1 分层依赖（禁止反向）

建议依赖链：

`core -> schema -> engine -> plugins -> stages -> templates -> reporting -> cli -> installer -> ui`

含义：

- 上层只依赖下层，避免循环与耦合扩散
- 插件产出标准结果，不直接写 state/report

## 4.2 核心模块职责

- `core`：时间、文件、执行器、日志、错误
- `schema`：状态模型、模板模型、基础校验
- `engine`：Template->Plan->Stage 执行内核
- `plugins`：checks/actions/evidence 扩展点
- `stages`：A~F 编排
- `state`：状态读写、汇总、保留
- `reporting/handover`：报告与交付包
- `installer`：目录、静态 UI、systemd 安装

## 4.3 运行时目录（v1）

推荐结构：

```text
<output>/
  state/      # overall/lifecycle/services/artifacts
  reports/    # 阶段报告
  evidence/   # 中间证据
  bundles/    # acceptance/handover/collect
  cache/
  ui/
```

要求：

- state 文件统一原子写（tmp -> rename）
- 命名统一、可追溯（含阶段与时间戳）
- 明确保留策略（报告/证据按份数清理；bundle 默认保守）

## 4.4 并发与一致性

- 统一全局锁，防止 `run/accept/handover/timer` 并发写状态
- 冲突时返回退出码 `4`（人工介入）
