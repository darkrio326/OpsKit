# 09 模板设计指南（Template Design Guide）

本指南基于 `docs/architecture/StackTemplate.md` 与 `docs/product-design/05-模板与插件体系.md`，用于约束模板设计边界，保证模板可复用、可审计、可演进。

## 1. 一个模板解决什么问题

模板只解决“某一类服务器用途”的运行治理问题，不解决业务开发问题。

- 定义关键对象：该用途包含哪些组件（systemd/compose/process）与依赖顺序
- 定义判定规则：组件是否健康、降级、失败（port/http/command/log）
- 定义动作策略：部署（Deploy 模式）、恢复（Recover）、证据采集（Accept）

模板产出应当是“可复核的运维结果”：

- 能跑通 A/B/D/E/F（Deploy 模板可额外覆盖 C）
- 能输出标准状态 JSON、报告和证据清单
- 能明确给出成功/失败判定，不依赖人工猜测
- 必须在“单台服务器”范围内自洽，不隐式依赖其他节点状态

## 2. 模板不应该做什么

模板不是万能脚本，以下行为必须禁止或下沉到引擎统一处理：

- 不改写通用阶段语义：A/B/D/E/F 的主流程由引擎控制，模板只能扩展
- 不直接写 state/report：插件只能返回结果对象，由引擎统一落盘
- 不绕过执行器：禁止插件直接 `exec.Command`，统一走 `executil`
- 不依赖外网：离线/内网场景必须可运行
- 不内置客户机密：模板与示例变量不得包含真实 IP、账号、路径、密钥

反模式：

- 把模板写成“平台专属部署脚本集合”
- 在模板里硬编码环境差异，导致无法迁移到其他服务器
- 用“主观经验描述”替代可验证检查条件

## 3. Check / Evidence 的设计原则

### 3.1 Check 设计原则

- 客观可判定：每个 check 必须有明确成功条件（如 HTTP 200、端口监听、unit active）
- 可分级：必须声明 `severity`（fail/warn/info），影响整体状态可解释
- 可控成本：必须有 `timeout/retry`，避免无限等待
- 可定位：失败输出需包含最小诊断信息（退出码、关键 stderr、上下文）
- 可移植：尽量使用系统通用命令与稳定接口，避免发行版私有行为
- 只读检查：check 不得对系统产生持久性状态变更

推荐最小集合：

- 存活：`systemd_unit_active` / `process_exists`
- 可达：`port_listening` / `http_probe`
- 资源：`disk/memory/load`
- 关键前置：`mount_check` / `time_sync_status` / `network_readiness`

### 3.2 Evidence 设计原则

- 可复核：证据必须可追溯（路径 + 时间 + hash + 采集命令）
- 可脱敏：对 `password/token/secret` 等敏感键统一掩码
- 可最小化：只采集验收必要数据，不采集与目标无关的大量日志
- 可比较：同类模板证据结构尽量一致，便于版本间 diff

推荐证据类型：

- `file_hash`：关键配置/二进制
- `dir_hash`：关键目录快照
- `command_output`：版本、状态、运行参数摘要
- `config_snapshot`：脱敏后的配置片段

## 4. Role 模板的边界

Role 模板用于“职责模板化”，不是“产品模板化”。建议定义两类角色：

- `blackbox-manage`：接管已有系统（金蝶/FCS/WO 等），重点是巡检、恢复、证据
- `deploy-manage`：自部署系统（MinIO/ELK/PowerJob 等），覆盖部署 + 运维闭环

边界约束：

- Role 只定义能力边界与最小契约，不绑定客户环境实现细节
- 业务差异通过变量文件表达，不通过改模板主结构表达
- Role 不负责权限系统与审批流，仅提供“可接入审计链路”的结果

一句话区分：

- Manage：我不负责安装，但我负责稳定接管和可验收输出
- Deploy：我负责离线部署到可运行，并同样输出可验收结果

## 5. Demo -> Production 的演进路径

目标不是“重写模板”，而是“逐步收敛契约”。

### 阶段 1：Demo（可演示）

- 使用去生产化组件与路径
- 打通 run/status/accept 基础链路
- 证据结构完整但内容可简化

验收口径：

- 能稳定生成 state JSON 和 evidence 包
- 失败能定位，成功可复核

### 阶段 2：Pilot（可试点）

- 引入真实服务拓扑（但仍不含客户敏感信息）
- 增加 readiness、recover 顺序与熔断策略
- 增加严格模板校验（必填变量、枚举、路径合法性）

验收口径：

- 同一模板可在至少两套环境复用
- 异常恢复行为可预测，退出码一致

### 阶段 3：Production（可交付）

- 固化兼容矩阵（OS/arch/依赖版本）
- 固化证据基线（manifest/hashes/reports/snapshots）
- 建立变更策略（模板版本号、升级说明、回滚说明）

验收口径：

- 通过发布前 `release-check` 与离线验收脚本
- 文档、模板、示例变量三者一致

## 6. 模板设计检查清单（提交前）

- 模板是否只描述对象/判定/策略三类信息
- 是否明确模式（Manage/Deploy）且边界清晰
- checks 是否可判定、可分级、可超时
- evidence 是否可复核且已脱敏
- 是否完全离线可运行
- 是否存在可直接复用的 demo vars 与 README
- 若第 1~5 节任一问题无法明确回答，视为模板设计未完成，不得进入实现

## 7. Review Gate 与执行约束

- 本文档可作为模板评审 Review Gate；未通过 Gate 的模板不得进入开发与发布
- 所有功能实现必须遵循 `docs/product-design/` 下的规范文档
- 如实现方案与 product-design 约束冲突，必须先与产品负责人确认，再进行变更

---

本指南为模板评审与发布门禁依据。后续如新增模板类型，先更新本指南，再扩展模板实现。
