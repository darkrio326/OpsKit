# 06 执行链路与控制策略

## 6.1 执行主链路

标准链路：

`Template Loader -> Vars Merge -> Normalizer -> PlanBuilder -> StageRunner -> State/Report Writer`

阶段执行：

- A：Checks
- B：Actions
- C：Deploy/Manage 分支
- D：Checks
- E：Recover 流程（readiness/start/verify/circuit）
- F：Evidence + bundle + handover

## 6.2 阶段汇总规则

- 存在 `fail` 级失败 -> `FAILED`
- 无 fail 但有 warn -> `WARN`
- 否则 `PASSED`

## 6.3 阻断策略（v1）

- A 失败：阻断后续关键阶段
- B 失败：阻断 C
- C 失败：仅在 `deploy` 模式阻断 D/E/F（`manage` 模式不阻断 D）
- D/E/F 失败：记录并输出，不强制触发危险补救

## 6.3.1 阻断策略实现状态（当前）

当前代码实现已落地以下规则：

- A 阶段 `FAILED`：后续阶段标记 `SKIPPED`
- B 阶段 `FAILED`：阻断 C 阶段
- C 阶段 `FAILED` 且模板模式为 `deploy`：阻断 D/E/F
- C 阶段 `FAILED` 且模板模式为 `manage`：D 阶段仍可执行

阻断后的阶段仍会生成阶段报告，报告中包含：

- `status=SKIPPED`
- `blockedBy`（阻断来源阶段）
- `reason`（阻断原因）

## 6.4 Recover 控制策略

- 先做 readiness（网络/挂载/时间）
- 按依赖顺序恢复
- 有限重试（默认 1 次）
- 熔断 cooldown（避免重启风暴）
- 失败自动 collect 并留证据

## 6.5 执行安全策略

- 外部命令统一经 `executil` 执行（超时、限流、脱敏、审计）
- 建议默认 allowlist + denylist
- 危险操作必须显式确认或禁用

## 6.6 并发控制与退出码

- 全局锁冲突返回 `4`
- 命令结果退出码统一映射：
  - `0` 成功
  - `1` 失败
  - `2` 前置条件不满足
  - `3` 部分成功（WARN）
  - `4` 需人工介入

## 6.7 执行门禁补充

- `template validate` 必须校验模板中引用的 check/action/evidence kind 是否受支持
- `run/install/accept` 执行前，必须校验所选阶段在模板中存在
- 若未满足上述前置条件，统一返回退出码 `2`
